#+TITLE: QwatchCapture
#+DATE: <2015-03-10 Tue>
#+AUTHOR: Shota TAKAHASHI
#+EMAIL: shotakaha@gmail.com
#+OPTIONS: ':nil *:t -:t ::t <:t H:3 \n:nil ^:nil arch:headline
#+OPTIONS: author:t c:nil creator:comment d:(not "LOGBOOK") date:t
#+OPTIONS: e:t email:nil f:t inline:t num:t p:nil pri:nil stat:t
#+OPTIONS: tags:t tasks:t tex:t timestamp:t toc:nil todo:t |:t
#+CREATOR: Emacs 24.4.1 (Org mode 8.2.10)
#+DESCRIPTION:
#+EXCLUDE_TAGS: noexport
#+KEYWORDS:
#+LANGUAGE: ja
#+SELECT_TAGS: export

* 何をするものか？

  IO-DATAのQwatchを使って定点観測するためのPythonスクリプトです。

* 動作環境

  - [[http://www.iodata.jp/product/lancam/lancam/ts-wlcam/][IO-DATA Qwatch TS-WLCAMシリーズ]]
    - USBケーブルしか付属しないので、TS-WLCAM用ADアダプター（[[http://www.ioplaza.jp/shop/g/g60-TVCXGA2-001/][TVC-XGA2]]）があるとよい
  - Python 2.7
  - MacOS X

* やってること

  - wgetで画像を取ってきて、その時の時刻でリネームする

#+begin_src bash
$ wget --http-user=USER --http-password=PASS http://QwatchIPADDRESS/snapshot.jpg
$ mv snapshot.jpg snapshots/YYYY-MMDD-hhmm-ss.jpg
#+end_src

** もうちょいやってること

   - ユーザ情報（USER、PASS）をファイル中に書くのは嫌なので、ConfigParserモジュールを使って外部ファイルから読むことにする
   - 以下のwgetのオプションを使えるようにしている
     - アクセスできなかった場合にタイムアウトする秒数（デフォルト 10秒に設定）
     - タイムアウトした際にリトライする回数（デフォルト 1回に設定）
     - ログをファイルを残すときのファイル名（デフォルト qwatch.logに設定）

* 使い方

** 設定ファイルを用意する

   - example.cfgをコピーしてCONFIG.cfgを新規作成する
   - 「CONFIG」の部分は任意
   - CONFIG.cfgの中身を自分のQwatchの設定に書き換える

*** 設定ファイルの書式

#+begin_src config
[Capture]
uri = http://QWATCHADDRESS/snapshot.jpg
user = USER
pass = PASS
#+end_src

** 実行する

   - configファイルを引数にして実行する

  #+begin_src bash
  $ python qwatch.py CONFIF.cfg
  #+end_src

** 画像の保存先

   - ファイル名は「snapshots/YYYY-MMDD-hhmm-ss.jpg」
   - カレントディレクトリに「snapshots/」を作成する
   - 公開ディレクトリへのシンボリックリンクでも良い

** cronに登録する

   - cronの編集には「crontab」コマンドを使用する（きっと直接編集しないほうがいい）
   - 使うオプションは下の２種類で十分

#+begin_src bash
$ crontab -l    ## Read crontab
$ crontab -e    ## Edit crontab
#+end_src

*** cronの書式

#+begin_src text
分 時 日 月 曜日 実行コマンド
#+end_src

*** 10分おきにキャプチャする場合（みかくにん）

#+begin_src text
*/10 * * * * `ABS-PATH-TO−QwatchCapture/qwatch.py config.cfg`
#+end_src
