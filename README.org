#+TITLE: QwatchCapture
#+DATE: <2015-03-10 Tue>
#+AUTHOR: Shota TAKAHASHI
#+EMAIL: shotakaha@gmail.com
#+OPTIONS: ':nil *:t -:t ::t <:t H:3 \n:nil ^:nil arch:headline
#+OPTIONS: author:t c:nil creator:comment d:(not "LOGBOOK") date:t
#+OPTIONS: e:t email:nil f:t inline:t num:t p:nil pri:nil stat:t
#+OPTIONS: tags:t tasks:t tex:t timestamp:t toc:nil todo:t |:t
#+CREATOR: Emacs 24.4.1 (Org mode 8.2.10)
#+DESCRIPTION:
#+EXCLUDE_TAGS: noexport
#+KEYWORDS:
#+LANGUAGE: ja
#+SELECT_TAGS: export

* 何をするものか？

  IO-DATAのQwatchを使って定点観測するためのPythonスクリプトです。

* 動作環境

  - [[http://www.iodata.jp/product/lancam/lancam/ts-wlcam/][IO-DATA Qwatch TS-WLCAMシリーズ]]
    - USBケーブルしか付属してないので注意
    - TS-WLCAM用ADアダプター（[[http://www.ioplaza.jp/shop/g/g60-TVCXGA2-001/][TVC-XGA2]]）があるとよい
  - MacOS X(10.10 Yosemite) + Python 2.7.9
  - Ubuntu (14.04LTS) + Python 2.7.6 + ffmpeg 2.6

* やってること

  - wgetで画像を取ってきて、その時の時刻でリネームする

#+begin_src bash
$ wget --http-user=USER --http-password=PASS http://QwatchIPADDRESS/snapshot.jpg
$ mv snapshot.jpg snapshots/YYYY-MMDD-hhmm-ss.jpg
#+end_src

  - 画像がある程度たまったら、早送り動画にする

#+begin_src bash
$ ffmpeg -y -f image2 -r 15 -pattern_type glob -i 'snapshots/*.jpg' -r 15 -an -vcodec libx264 -pix_fmt yuv420p video.mp4
$ mv video.mp4 snapshots/
#+end_src

  - これらの動作をcronに食べさせて、定期的に実行している


** もうちょいやってること

   - ユーザ情報（USER、PASS）をファイル中に書くのは嫌
     - PythonのConfigParserモジュールを使って外部ファイルから読むことにする
   - 以下のwgetのオプションを使えるようにしている
     - アクセスできなかった場合にタイムアウトする秒数（デフォルト 10秒に設定）
     - タイムアウトした際にリトライする回数（デフォルト 1回に設定）
     - ログをファイルを残すときのファイル名（デフォルト qwatch.logに設定）

* 使い方

** 設定ファイルを用意する

   - qwconf.exampleをコピーしてmyconf.confを新規に作成する
   - myconf.confの中身を自分のQwatchの設定に書き換える

*** 設定ファイルの書式

#+begin_src config
[WEBCAM]
name = CAMNAME
uri = http://QW-ADDRESS/snapshot.jpg
user = USER
pass = PASS
base = WEBHOME/%(name)s
#+end_src

    - 大文字の部分を書き換えればよい
    - baseは保存先ディレクトリのつもり
      - 中で日付ごとに保存される
      - 「$WEBHOME/$CAMNAME/2015/03/11/2015-0311-2230-15.jpg」みたいな感じ

*** 複数台カメラを設定する場合

    - １台ごとにconfファイルを用意して、引数にしてもOK
    - １つのconfファイルに複数台の設定を書いてもOK

#+begin_src config
[WEBCAM1]
name = CAMNAME1
uri = http://QW-ADDRESS-1/snapshot.jpg
user = USER
pass = PASS
base = WEBHOME/%(name)s

[WEBCAM2]
name = CAMNAME2
uri = http://QW-ADDRESS-2/snapshot.jpg
user = USER
pass = PASS
base = WEBHOME/%(name)s
#+end_src

    - セクション（WEBCAM1、WEBCAM2の部分）は違うものにする
      - 同じにすると、あとの設定に上書きされるので注意
    - 同じ場所に画像を保存したい場合は「name」を一緒にする
      - あとで動画を作ることを考えると非推奨

** 実行する

   - confファイルを引数にして実行する

  #+begin_src bash
  $ ./qwatch.py QWCONF.conf
  #+end_src

   - 複数のconfファイルを指定することもできる

#+begin_src bash
$ ./qwatch.py QWCONF.conf QWCONF2.conf
#+end_src

*** ヘルプを見る

    - オプションについてはヘルプを確認して下さい

#+begin_src bash
$ ./qwatch.py -h
#+end_src


** 画像の保存先

   - confファイルの「base」を元にディレクトリを作成する
     - ファイル名は「base/name/YYYY/MM/DD/YYYY-MMDD-hhmm-ss.jpg」
   - ウェブページでチェックしたい場合は、baseの部分をそこまでのシンボリックにするといい
     - なんかうまく説明できていないけれど、各自で考えてください

** cronに登録する

   - cronの編集には「crontab」コマンドを使用する
     - いろいろ調べると、cronファイルを作成し、crontabに食べさせるのがよいらしい
     - /etc/cron.d/の直接編集、「crontab -e」による編集はしないほうが安全
   - crontabは上書きされてしまうので、既に設定がある人はリダイレクト使ってバックアップを取るといいかも

#+begin_src bash
$ crontab crontab.example   ## Read crontab from file
$ crontab -l                ## Check crontab
$ crontab -l > cron.bk      ## Easy back up
#+end_src

*** cronの書式

#+begin_src text
分 時 日 月 曜日 実行コマンド
#+end_src

*** 10分ごとに画像をキャプチャする場合

#+begin_src text
QWDIR=      ## qwatch.py があるディレクトリを指定する
QWCONFIGS=  ## confファイルを指定（複数指定できる、半角スペースで区切る（みかくにん））
*/10 * * * * `cd $QWDIR && ./qwatch.py $QWCONFIG`
#+end_src

*** 1時間ごとにタイムラプス動画を作る場合（みかくにん）

    - 画像の保存先を日付ごとにしたので、これではできない

#+begin_src text
QWDIR=     ## qwatch.py があるディレクトリを指定する

FFMPEG_OPT_IN="-y -f image2 -r 15"                          ## 入力ファイルオプション
FFMPEG_OPT_OUT="-r 15 -an -vcodec libx264 -pix_fmt yuv420p" ## 出力ファイルオプション
FFMPEG_OUT_FILE=video.mp4    ## 出力ファイル名

5 * * * * `cd $QWDIR && ffmpeg ${FFMPEG_OPT_IN} -pattern_type glob -i 'snapshots/*.jpg' ${FFMPEG_OPT_OUT} ${FFMPEG_OUTFILE} && mv ${FFMPEG_OUTFILE} snapshots/`
#+end_src

    - 「-pettern_type glob -i 'snapshots/*.jpg'」の部分でどうしてもエラーが出てしまうので、入力オプションから外し、ベタ書きしている
    - キャプチャの実行と時間をずらしてある（毎時５分）

*** ログの確認

    - cronのログは以下のディレクトリ／ファイルで確認できる

#+begin_src bash
$ tail /var/log/syslog
$ sudo ls -ltrh /var/spool/nullmailer/queue/ | tail   ## ログファイル名、タイムスタンプ、サイズを確認する
$ sudo less /var/spool/nullmailer/queue/LOGFILE       ## 上で調べたLOGFILE名の中には、cron実行時のログが吐き出されている
#+end_src
